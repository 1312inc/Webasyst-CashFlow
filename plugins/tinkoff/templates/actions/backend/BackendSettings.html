<h1>Tinkoff</h1>

<pre>{$settings|print_r}</pre>

<form action="" method="post" data-tinkoff-settings-wrapper>

    <div class="switch-with-text custom-mb-20">
        <span class="switch" data-tinkoff-settings-enable-switch>
        <input type="hidden" name="settings[enabled]" value="0">
        <input type="checkbox" name="settings[enabled]" id="cash-tinkoff-enable" {if $settings.enabled}checked{/if}>
        </span>
        <label for="cash-tinkoff-enable" data-active-text="Интеграция включена"
               data-inactive-text="Интеграция отключена">
            {if $settings.enabled}Интеграция включена{else}Интеграция отключена{/if}
        </label>
    </div>

    <div class="clear"></div>

    <div class="toggle" data-tinkoff-companies-toggle>
        {foreach $settings.companies as $companySettings}
            <span>
            {$companySettings.company|escape}
        </span>
        {/foreach}
    </div>

    {foreach $settings.companies as $companySettings}
        <div data-tinkoff-settings-company="{$companySettings.company}">
            <div class="block fields form" data-tinkoff-company-token-wrapper="{$companySettings.company}">
                <input type="hidden" value="{$companySettings.company}"
                       data-tinkoff-company-origin-name
                       name="settings[companies][{$companySettings@index}][companyOldName]"/>
                <div class="field-group">
                    <div class="field">
                        <div class="name">Название</div>
                        <div class="value">
                            <input type="text" class="bold" value="{$companySettings.company}"
                                   name="settings[companies][{$companySettings@index}][company]"/>
                        </div>
                    </div>
                    <div class="field">
                        <div class="name"></div>
                        <div class="value">
                            <div class="switch-with-text custom-mb-20">
                            <span class="switch" data-tinkoff-settings-enable-switch>
                            <input type="hidden" name="settings[companies][{$companySettings@index}][enabled]"
                                   value="0">
                            <input type="checkbox" name="settings[companies][{$companySettings@index}][enabled]"
                                   id="tinkoff-company-enable-{$companySettings@iteration}"
                                   {if $companySettings.enabled}checked{/if}>
                            </span>
                                <label for=tinkoff-company-enable-{$companySettings@iteration}"
                                       data-active-text="Интеграция включена"
                                       data-inactive-text="Интеграция отключена">
                                    {if $companySettings.enabled}Интеграция включена{else}Интеграция отключена{/if}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field">
                        <div class="name">Token</div>
                        <div class="value">
                            <input type="text" class="bold" value="" data-tinkoff-company-token="token"
                                   name="settings[companies][{$companySettings@index}][token]"/>
                            {if $companySettings.token.valid}
                                <p class="hint">Token exists.</p>
                            {else}
                                <p class="hint">Token not exists or invalid.</p>
                            {/if}
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field">
                        <div class="value">
                            <button class="button">{if $companySettings.token.valid}Update token{else}Save token{/if}</button>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            {foreach $companySettings.accounts as $companyAccountSetting}
                <input type="hidden" value="{$companyAccountSetting.number}"
                       name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][number]"/>
                <div class="block fields form">
                    <h3>{$companyAccountSetting.number}</h3>
                    <div class="field">
                        <div class="name"></div>
                        <div class="value">
                            <div class="switch-with-text custom-mb-20">
                            <span class="switch" data-tinkoff-settings-enable-switch>
                            <input type="hidden"
                                   name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][enabled]"
                                   value="0">
                            <input type="checkbox"
                                   name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][enabled]"
                                   id="tinkoff-company-enable-{$companySettings@iteration}-{$companyAccountSetting@index}"
                                   {if $companySettings.enabled}checked{/if}>
                            </span>
                                <label for=tinkoff-company-enable-{$companySettings@iteration}-{$companyAccountSetting@index}"
                                       data-active-text="Интеграция включена"
                                       data-inactive-text="Интеграция отключена">
                                    {if $companySettings.enabled}Интеграция включена{else}Интеграция отключена{/if}
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="field-group">
                        <div class="field">
                            <div class="name">Account to import</div>
                            <div class="value">
                                <select name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][account]">
                                    {foreach $accounts as $account}
                                        <option value="{$account->getId()}"
                                                {if $account->getId() == $companyAccountSetting.account|default:0}selected{/if}
                                        >{$account->getName()|escape}</option>
                                    {/foreach}
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <div class="name">Income category to import</div>
                            <div class="value">
                                <select name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][income_category]">
                                    {foreach $incomeCategories as $category}
                                        <option value="{$category->getId()}"
                                                {if $category->getId() == $companyAccountSetting.income_category|default:0}selected{/if}
                                        >{$category->getName()|escape}</option>
                                    {/foreach}
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <div class="name">Expense category to import</div>
                            <div class="value">
                                <select name="settings[companies][{$companySettings@index}][accounts][{$companyAccountSetting.number}][expense_category]">
                                    {foreach $expenseCategories as $category}
                                        <option value="{$category->getId()}"
                                                {if $category->getId() == $companyAccountSetting.expense_category|default:0}selected{/if}
                                        >{$category->getName()|escape}</option>
                                    {/foreach}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field-group">
                        <div class="field">
                            <div class="value">
                                <input type="submit" class="button" value="Save settings">
                            </div>
                        </div>
                    </div>
                </div>
            {/foreach}

            <div class="block fields form" data-tinkoff-company-import-wrapper="{$companySettings@index}">
                <div class="field-group">
                    <div class="field">
                        <div class="name">Дата начала</div>
                        <div class="value"><input type="text"
                                                  data-tinkoff-company-import-start
                                                  placeholder="{date('Y-m-d', strtotime('-1 day'))}"
                                                  value="{date('Y-m-d', strtotime('-1 day'))}">
                        </div>
                    </div>
                    <div class="field">
                        <div class="name">Дата конца</div>
                        <div class="value"><input type="text"
                                                  data-tinkoff-company-import-end
                                                  placeholder="{date('Y-m-d')}"
                                                  value="{date('Y-m-d')}">
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field">
                        <div class="value">
                            <button class="button">Import</button>
                            <p class="hint">Import all accounts</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {/foreach}
</form>

<script>
    (function () {
        // debugger;
        $("[data-tinkoff-companies-toggle]").waToggle({
            change: function (event, target, toggle) {
                alert($(target).text());
            }
        });

        $("[data-tinkoff-settings-enable-switch]").waSwitch({
            ready: function (wa_switch) {
                let $label = wa_switch.$wrapper.siblings('label');
                wa_switch.$label = $label;
                wa_switch.active_text = $label.data('active-text');
                wa_switch.inactive_text = $label.data('inactive-text');
            },
            change: function (active, wa_switch) {
                wa_switch.$label.text(active ? wa_switch.active_text : wa_switch.inactive_text);
            }
        });

        var $companyToken = $('[data-tinkoff-company-token-wrapper]');

        $companyToken.on('click', 'button', function (e) {
            let $wrapper = $(this).closest('[data-tinkoff-company-token-wrapper]');
            // debugger;
            $.post('?plugin=tinkoff&module=backend&action=saveToken', {
                'token': $wrapper.find('[data-tinkoff-company-token="token"]').val(),
                'company': $wrapper.data('tinkoff-company-token-wrapper'),
            }, function (html) {

            });

            return false;
        });

        var $allSettings = $('form[data-tinkoff-settings-wrapper]');
        $allSettings.on('submit', function (e) {
            e.preventDefault();
            let $form = $(this);

            $.post('?plugin=tinkoff&module=backend&action=saveSettings', $form.serialize(), function (r) {
                if (r.status === 'ok') {
                    // $form.find('[data-tinkoff-company-origin-name]').val($form.find('input[name$="][company]"]').val())
                    alert('ok');
                } else {
                    alert(r.data);
                }
            });

            return false;
        });

        $('[data-tinkoff-company-import-wrapper]').on('click', 'button', function (e) {
            e.preventDefault();
            let $wrapper = $(this).closest('[data-tinkoff-company-import-wrapper]');

            $.post('?plugin=tinkoff&module=backend&action=import', {
                'start': $wrapper.find('[data-tinkoff-company-import-start]').val(),
                'end': $wrapper.find('[data-tinkoff-company-import-end]').val(),
            }, function (r) {
                alert(r.data);
            });
        })

    }(jQuery))
</script>