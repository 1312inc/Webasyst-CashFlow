{$profile_id = $current_profile_id|default:1}
{$profile = ifset($profiles, $profile_id, [])}

{function name="render_account" _account=[]}
    <strong>{$_account.company|escape|default:''}</strong>
    <br>
    <span class="hint">
        {$_account.account_description|escape|default:''}
        {$_account.account_number|escape|default:''}
    </span>
{/function}

<script>
    let $bar;
    let profile_id = {$profile_id};
    let profiles = {$profiles|default:null|json_encode};
</script>

<div id="cash-import-page" class="article wide">
    <div class="article-body">
        <h1>[`Тинькофф &rarr; Деньги`]</h1>

        {include 'templates/actions/import/ImportTab.html'}

        <p>[`Импорт операций из «Тинькофф Бизнес» для юридических лиц (ООО, ИП) по <a href="https://www.tinkoff.ru/business/open-api/">API</a>.`]</p>

        {if $profile && count($profile.imports)}
        <div>
            <p class="small">[`Review and manage previous import results:`]</p>
            <ul class="chips rounded small">
                {** @var cashImportDto $import **}
                {foreach $profile.imports as $import}
                    <li>
                        <a href="{$wa_app_url}import/{$import->id}?importinfo={base64_encode($import->filename|escape|cat:' / '|cat:$import->create_datetime)}">
                            <i class="fas fa-file-excel" style="color: #499b5e;"></i>
                            <strong>{sprintf('%d transactions', $import->success)}</strong>
                            {$import->create_datetime|wa_datetime:humandatetime}

                            <span class="hint">
                            {$import->filename|escape|truncate:24}
                        </span>
                        </a>
                    </li>
                {/foreach}
                <li class="transparent small">
                    <a href="#" class="count js-imports-delete">
                        <i class="fas fa-times-circle"></i>
                        [`Dismiss import history`]
                    </a>
                </li>
            </ul>
        </div>
        <hr>
        {/if}

        <div class="fields" id="js-profiles">
            <div class="field">
                <div class="name">[`Тинькофф ID`]</div>
                <div class="value">
                    <div class="custom-mb-8{if empty($profile.tinkoff_id)} hidden{/if}">
                        <strong>
                        {if !empty($profile.status)}
                            {if $profile.status === 'ok'}
                            <i class="fas fa-check-circle text-green"></i> [`Подключено!`]
                            {elseif $profile.status === 'warning'}
                            <i class="fas fa-exclamation-circle text-yellow" title="{$profile.status_description|escape}"></i> [`Ошибка`].
                            <a href="javascript:void(0);" class="js-tinkoff-connect">[`Подключить`]</a>
                            {elseif $profile.status === 'danger'}
                            <i class="fas fa-exclamation-triangle text-red" title="{$profile.status_description|escape}"></i> [`Ошибка`].
                            {/if}
                        {/if}
                        </strong>
                        <strong class="hint{if empty($profile.update_date)} hidden{/if}">
                            [`Последнее обновление:`] <span class="js-update-date">{$profile.update_date|escape|default:''}</span>
                        </strong>
                        <br>
                        <span class="hint js-tinkoff-id">{$profile.tinkoff_id|escape|default:''}</span>
                    </div>
                    <div class="dropdown" id="js-dropdown" style="width: 250px;{if empty($profiles)} display: none{/if}">
                        <button class="dropdown-toggle button outlined" type="button" style="text-align: left">
                            {if isset($profiles[$profile_id])}
                                {render_account _account=$profiles[$profile_id]}
                            {/if}
                        </button>
                        <div class="dropdown-body">
                            <ul class="menu">
                                {foreach $profiles as $_profile_id => $_profile}
                                <li>
                                    <div class="custom-ml-16 custom-my-4">
                                        <a href="javascript:void(0);" data-profile-id="{$_profile_id}">
                                            {render_account _account=$_profile}
                                        </a>
                                    </div>
                                </li>
                                {/foreach}
                                <li>
                                    <a href="javascript:void(0);" class="button white js-tinkoff-connect">+ [`Подключить`]</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {if empty($profiles)}
                        <button class="button orange js-tinkoff-connect" type="button">[`Подключить`]</button>
                    {else}
                        <p class="hint">[`Счет из которого производится импорт`]</p>
                    {/if}
                    <div class="error-msg state-error"></div>
                </div>
            </div>

            {if !empty(profiles)}
                {foreach $profiles as $_profile_id => $_profile}
                    {$is_hidden = $_profile_id != $profile_id}
                <div class="custom-mt-16 js-tab-content-{$_profile_id}{if $is_hidden} hidden{/if}">
                    {include file="./BackendSettingsProfile.html" profile_id=$_profile_id profile=$_profile is_hidden=$is_hidden inline}
                </div>
                {/foreach}
            {/if}
        </div>
    </div>
</div>

<script>
    function saveProfile(profile, callback) {
        profile.profile_id = profile_id;
        $.get('?plugin=tinkoff&module=profileEdit', profile, function (data) {
            console.log('profileEdit', data);
            if (typeof callback === 'function') {
                callback();
            }
        });
    }

    function tinkoffConnect($button, param) {
        $button.addClass('disabled');
        $.get('?plugin=tinkoff&module=auth'+ (param ? '&add=1' : ''), function (data) {
            data = (data.hasOwnProperty('data') ? data.data : data);
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else if (data.error_description) {
                alert(data.error_description);
            } else if (data.errors) {
                alert(data.errors);
            } else if (data.profiles) {
                window.location.reload();
            }
        });
    }

    function renderText(text) {
        $('.js-tab-content-'+ profile_id).find('.js-info').html(text);
    }

    let url = '?plugin=tinkoff&action=run';
    let error = '{$error|default:''}';
    let process_id = undefined;
    let $start_button = $('.js-cash-tinkoff-start, .js-cash-tinkoff-update');
    let $dropdown_button = $('#js-dropdown');
    let datepicker_options = {
        changeMonth: true,
        changeYear: true,
        shortYearCutoff: 2,
        dateShowWeek: false,
        showOtherMonths: true,
        selectOtherMonths: true,
        stepMonths: 1,
        numberOfMonths: 1,
        gotoCurrent: true,
        constrainInput: false,
        dateFormat: 'yy-mm-dd',
        onSelect: function (date) {
            $(this).closest('div').find('[name$="[import_period]"]').prop('checked', true).val(date);
        }
    };
    let step = function (profile_id, delay, $progressbar) {
        delay = delay || 2000;
        setTimeout(function () {
            $.post(url, { processid: process_id, profile_id: profile_id }, function (response) {
                renderText('');
                if (!response) {
                    step(profile_id, 3000, $progressbar);
                } else if (response && response.error) {
                    $('.js-tab-content-'+ profile_id).find('.error-msg').text(response.error);
                } else if (response && response.ready) {
                    if ($progressbar) {
                        $progressbar.set({ percentage: 100 });
                    }
                    if (response.text_legend) {
                        renderText(response.text_legend);
                    }
                    setTimeout(function () {
                        let cash_account = $('select[name="profiles['+ profile_id +'][cash_account]"]').val();
                        renderText('');
                        $('.progressbar').hide();
                        window.location = window.appState.baseUrl +'account/'+ cash_account +'?show_success_import_hint=1';
                    }, 1000);
                } else {
                    if ($progressbar && response && response.progress) {
                        $progressbar.set({ percentage: response.progress });
                    }
                    if (response.text_legend) {
                        renderText(response.text_legend);
                    }
                    step(profile_id, null, $progressbar);
                }
            }, 'json').error(function () {
                step(profile_id, 3000, $progressbar);
            });
        }, delay);
    };

    $date_picker = $('[name$="[begin_import_period]"]');
    $date_picker.datepicker(datepicker_options);

    if (error) {
        if (confirm(error)) {
            error = '';
            window.location.href = '?plugin=tinkoff';
        }
    }

    $('.js-tinkoff-connect').on('click', function () {
        tinkoffConnect($(this));
    });

    $start_button.on('click', function () {
        let $that = $(this);
        let $tab_content = $('.js-tab-content-'+ profile_id);
        let $cash_account = $('select[name="profiles['+ profile_id +'][cash_account]"]');

        if (!$cash_account.val()) {
            setTimeout(function () {
                $cash_account.removeClass('state-error');
            }, 1500);
            $cash_account.addClass('state-error');
            return;
        }

        let instance = profiles[profile_id]['progressbar'];
        let form_data = $tab_content.find('input, textarea, select').serialize();

        $that.addClass('hidden');
        $tab_content.find('.js-progressbar').removeClass('hidden');
        renderText('<div class="spinner custom-mr-4"> </div>[`Подключение...`]');
        saveProfile(form_data, function () {
            $.post(url, form_data, function (response) {
                renderText('');
                if (response && response.error) {
                    $tab_content.find('.js-error-msg').text(response.error);
                } else if (response && response.processid) {
                    process_id = response.processid;
                    if (instance && response.progress) {
                        instance.set({ percentage: response.progress });
                    }
                    if (response.text_legend) {
                        renderText(response.text_legend);
                    }
                    step(profile_id, null, instance);
                } else {
                    $tab_content.find('.js-error-msg').text('Server error');
                }
            }, 'json').error(function () {
                $tab_content.find('.js-error-msg').text('Server error');
            });
        });
    });

    $dropdown_button.waDropdown({
        items: '.menu > li a',
        change: function (event, target) {
            profile_id = $(target).data('profile-id');
            if (profile_id) {
                $('[name="profile_id"]').val(profile_id);
                $('[class*=js-tab-content').addClass('hidden');
                $('.js-tab-content-'+ profile_id).removeClass('hidden');
                if (profiles.hasOwnProperty(profile_id)) {
                    let $up_dt = $('.js-update-date');
                    if (profiles[profile_id].hasOwnProperty('update_date') && profiles[profile_id]['update_date']) {
                        $up_dt.text(profiles[profile_id]['update_date']);
                        $up_dt.closest('strong.hint').removeClass('hidden');
                    } else {
                        $up_dt.closest('strong.hint').addClass('hidden');
                    }
                    if (profiles[profile_id].hasOwnProperty('tinkoff_id')) {
                        $('.js-tinkoff-id').text(profiles[profile_id]['tinkoff_id']);
                    }
                }
            }
        }
    });

    $('.js-reset-import').on('click', function (e) {
        let url = '?plugin=tinkoff&action=resetImport';
        e.preventDefault();
        $.get(url, function (data) {
            $.waDialog({
                html: data.data || '',
                onOpen: function ($dialog_wrapper, d) {
                    let $error_msg = $dialog_wrapper.find('.errormsg');
                    let $submit_button = $dialog_wrapper.find('.js-ok');

                    setTimeout(function () {
                        $dialog_wrapper.find('[name="code"]').trigger('focus');
                    }, 13.12);

                    $error_msg.hide();

                    $dialog_wrapper.find('[name="code"]').on('keypress', function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            $submit_button.trigger('click');
                        }
                    });

                    $submit_button.after($.cash.$loading).on('click', function (e) {
                        e.preventDefault();
                        $.post(url, $dialog_wrapper.find('form').serialize() +'&profile_id='+ profile_id, function (r) {
                            $.cash.$loading.remove();
                            if (r.status === 'ok') {
                                d.close();
                                window.location.reload();
                            } else {
                                $error_msg.text(r.errors.join(' ')).show();
                            }
                        }, 'json');
                    });

                    $dialog_wrapper.find('.js-close').on('click', function (e) {
                        d.close();
                    });
                }
            });
        })
    });

    $('.js-settings-show').on('click', function (e) {
        e.preventDefault();
        $(this).hide();
        $('.js-tab-content-'+ profile_id).find('.js-settings-block').toggle('fast');
    });

    $('.js-imports-delete').on('click', function (e) {
        e.preventDefault();
        if (!confirm($_('Clear import history (don’t worry, imported transactions will not be affected)?'))) {
            return;
        }

        $.post('?module=import&action=deleteAll&provider=api_tinkoff_{$profile.cash_account|escape|default: ''}', function (r) {
            if (r.status === 'ok') {
                window.location.reload();
            } else {
                self.log(r.errors.join("\n"));
                alert(r.errors.join("\n"));
            }
        }, 'json');
    })
</script>
