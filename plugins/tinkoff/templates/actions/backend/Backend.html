<div id="cash-import-page" class="article wide">
    <div class="article-body">
        <h1>[`Tinkoff &rarr; Cash`]</h1>

        {include 'templates/actions/import/ImportTab.html'}

        <p>[`Интеграция с Тинькофф банком доступна только для юридических лиц`]</p>

        <div class="fields">
            <div class="field">
                <div class="name">
                    [`Тинькофф ID`]
                </div>
                <div class="value">
                    {if empty($profile.tinkoff_id)}
                        <a href="javascript:void(0);" class="button orange js-tinkoff-connect">[`Подключить`]</a>
                    {/if}
                    <div{if empty($profile.tinkoff_id)} class="hidden"{/if}>
                        <strong class="js-tinkoff-id">{$profile.tinkoff_id|escape|default:''}</strong>
                        <br>
                        <span class="hint">
                            [`Все подключено! Последний коннект:`] <span class="js-connect-date">{$profile.last_connect_date|escape|default:''}</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="field">
                <div class="name">
                    [`Импорт операций`]
                </div>
                <div class="value">
                    <div class="custom-mb-4">
                        <label>
                            <span class="wa-radio">
                                <input type="radio" name="" value="" disabled />
                                <span></span>
                            </span>
                            [`All time`]
                        </label>
                        <span class="hint"></span>
                    </div>
                    <div>
                        <label>
                            <span class="wa-radio">
                                <input type="radio" name="" value="" disabled />
                                <span></span>
                            </span>
                            [`Only orders paid after`]
                        </label>
                        <span class="input-with-inner-icon left">
                            <input type="text" name="" class="shorter small" disabled />
                            <span class="icon"><i class="fas fa-calendar"></i></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="custom-my-24">
                <hr class="custom-m-0">
            </div>

            <div class="field custom-mb-40">
                <div class="name"></div>
                <div class="value">
                    <a href="{$settings_url}">[`Перейти в настройки импорта`]</a>
                </div>
            </div>

            <div class="field">
                <div class="name"></div>
                <div class="value">
                    <input
                        type="button"
                        id="cash-tinkoff-start"
                        class="button green"
                        value="[`Импортировать операции из банка`]"
                        {if empty($profile.tinkoff_id)}disabled{/if}
                    />
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let profile_id = {$profile_id|default:1};
    let $start_button = $('#cash-tinkoff-start');

    function saveProfile(profile) {
        profile.profile_id = profile_id;
        $.get('?plugin=tinkoff&module=profileEdit', profile, function (data) {
            console.log('profileEdit', data);
        });
    }

    $('.js-tinkoff-connect').on('click', function () {
        let $that = $(this);
        $that.addClass('disabled');
        $.get('?plugin=tinkoff&module=auth', { 'ref': 'import' }, function (data) {
            console.log('data', data);
            if (data.data.redirect_url) {
                window.location.href = data.data.redirect_url;
            } else if (data.data.error_description) {
                alert(data.data.error_description);
            } else if (data.data.tinkoff_id) {
                let $t_id = $('.js-tinkoff-id');
                let dt = new Date();
                let dformat = dt.toLocaleDateString().replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1') +' '+ dt.toTimeString().replace(/(\d+):(\d+):(\d+).*/, '$1:$2:$3');

                $t_id.closest('.hidden').removeClass('hidden');
                $that.addClass('hidden');
                $t_id.text(data.data.tinkoff_id);
                $('.js-connect-date').text(dformat);
                $start_button.attr('disabled', false);

                saveProfile({ 'last_connect_date': dformat, 'tinkoff_id': data.data.tinkoff_id });
            }
        });
    });

    $start_button.on('click', function () {
        alert('Импорт. Начало...');
    });
</script>
