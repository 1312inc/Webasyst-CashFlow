{$percentage = ifset($profile, 'run_data', 'progress', 0)}

<input type="hidden" name="profile_id" value="{$profile_id}"/>
<div class="field">
    <div class="name for-input">
        [`Счет`]
    </div>
    <div class="value">
        <div class="wa-select">
            <select name="profiles[{$profile_id}][cash_account]" autocomplete="off" class="bold js-account-select"{if !empty($profile.cash_account) && $profile.cash_account > 0} disabled{/if}>
            {if empty($profile.cash_account) || !is_numeric($profile.cash_account)}
                <option value="new_account">[`Создать новый счет...`]</option>
            {/if}
            {foreach $cash_accounts as $_cash_account}
                <option value="{$_cash_account.id}"{if $profile.cash_account|default:'0' == $_cash_account.id} selected{/if} data-count-transaction="{$_cash_account.count_transaction|escape|default:'0'}">
                    {$_cash_account.currency|escape} — {$_cash_account.name|escape}
                </option>
            {/foreach}
            </select>
        </div>
        <p class="state-caution small hidden"><i class="fas fa-exclamation-triangle"></i> [`<b>Лучше создать новый счет!</b> Чтобы избежать дублирования операций, и баланс счета в «Деньгах» совпадал с балансом в Тинькофф Бизнесе, рекомендуем включать импорт в отдельный счет, в котором еще нет других операций.`]</p>
    </div>
</div>

<div class="fields-group js-settings-block" style="display: none">
    <h5 class="heading">[`Маппинг категорий`]</h5>

    <h6 class="heading">[`Расходы`]</h6>
    {foreach $expense_operations as $_name => $_desc}
    {$selected = $profile['mapping'][$_name]|default: cashTinkoffPlugin::AUTO_MAPPING_FLAG}
    <div class="field">
        <div class="name">{$_desc}</div>
        <div class="value">
            <div class="wa-select">
                <select name="profiles[{$profile_id}][mapping][{$_name}]" autocomplete="off">
                    <option value="{cashTinkoffPlugin::AUTO_MAPPING_FLAG}">* [`Aвтопилот`]</option>
                    {foreach $categories as $_category}
                        {if $_category.type == 'expense'}
                            <option value="{$_category.id}"{if $selected == $_category.id} selected{/if}>{$_category.name}</option>
                        {/if}
                    {/foreach}
                </select>
            </div>
        </div>
    </div>
    {/foreach}

    <h6 class="heading">[`Доходы`]</h6>
    {foreach $income_operations as $_name => $_desc}
    {$selected = $profile['mapping'][$_name]|default: cashTinkoffPlugin::AUTO_MAPPING_FLAG}
    <div class="field">
        <div class="name">{$_desc}</div>
        <div class="value">
            <div class="wa-select">
                <select name="profiles[{$profile_id}][mapping][{$_name}]" autocomplete="off">
                    <option value="{cashTinkoffPlugin::AUTO_MAPPING_FLAG}">* [`Aвтопилот`]</option>
                    {foreach $categories as $_category}
                        {if $_category.type == 'income'}
                            <option value="{$_category.id}"{if $selected == $_category.id} selected{/if}>{$_category.name}</option>
                        {/if}
                    {/foreach}
                </select>
            </div>
        </div>
    </div>
    {/foreach}

    <div class="field">
        <div class="name">
            [`Таймаут обновления`]
        </div>
        <div class="value">
            <input type="text" name="profiles[{$profile_id}][update_timeout]" value="{$profile.update_timeout|default:''}" autocomplete="off" placeholder="{cashTinkoffPlugin::DEFAULT_UPDATE_TIMEOUT}">
            <p class="hint">{sprintf('[`Указывается целое число в минутах, но не менее %s.`]', cashTinkoffPlugin::DEFAULT_UPDATE_TIMEOUT)}</p>
        </div>
    </div>
</div>

<div class="field">
    <div class="name">
        [`Импорт операций`]
    </div>
    <div class="value">
        {if empty($profile.update_time)}
            <div class="custom-mb-4">
                <label>
                    <span class="wa-radio">
                        <input type="radio" name="profiles[{$profile_id}][import_period]" value="all" checked />
                        <span></span>
                    </span>
                    [`All time`]
                </label>
            </div>
            <div>
                <label>
                    <span class="wa-radio">
                        <input type="radio" name="profiles[{$profile_id}][import_period]" value="" />
                        <span></span>
                    </span>
                    [`Only orders paid after`]
                </label>
                <span class="input-with-inner-icon left">
                    <input type="text" name="profiles[{$profile_id}][begin_import_period]" class="shorter small" autocomplete="off"/>
                    <span class="icon"><i class="fas fa-calendar"></i></span>
                </span>
            </div>
        {else}
            <input
                type="button"
                class="button green js-cash-tinkoff-update"
                value="{if empty($profile.run_data)}[`Обновить`]{else}[`Возобновить`]{/if}"
            />
            <p class="small">
                <em>
                    {sprintf('[`Чтобы обновить уже импортированные транзакции, необходимо вручную удалить соответствующие им операции и %sперезапустить импорт заново%s.`]', "<a href=\"?plugin=tinkoff&action=reset&profile_id=`$profile_id`\" class=\"js-reset-import\">", '</a>')}
                </em>
            </p>
        {/if}
    </div>
</div>

{if empty($profile.update_time)}
<div class="field">
    <div class="name"></div>
    <div class="value">
        <input
            type="button"
            class="button green js-cash-tinkoff-start"
            value="[`Запустить импорт`]"
            {if empty($profile.tinkoff_id) && !$self_mode}disabled{/if}
        />
    </div>
</div>
{/if}

<hr class="custom-mt-16" />
<div class="field custom-mb-12">
    <div class="name"></div>
    <div class="value">
        <a class="js-settings-show">[`Показать все настройки`]</a>
    </div>
</div>

<div class="field">
    <div class="name"></div>
    <div class="value">
        {if empty($profile.update_time) || !empty($percentage)}
        <div class="progressbar js-progressbar{if empty($percentage)} hidden{/if}"></div>
        {/if}
        <div class="js-info hint"></div>
        <div class="error-msg state-error custom-pt-8 js-error-msg"></div>
    </div>
</div>

<script>
    $bar = $('.js-tab-content-'+ {$_profile_id}).find('.js-progressbar').waProgressbar({
        'color': '#ffdd2e',
        'percentage': {$percentage},
        'text-inside': true
    });
    $bar.find('.progressbar-text').css({ 'color':'black', 'font-weight': 'bold' });
    profiles[{$_profile_id}]['progressbar'] = $bar.data('progressbar');
</script>
