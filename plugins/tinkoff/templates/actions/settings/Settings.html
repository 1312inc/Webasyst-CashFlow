<h1>[`Плагин Тинькофф для бизнеса`]</h1>

<div class="fields form">
    <form action="?plugin=tinkoff&module=profileEdit&profile_id={$profile_id}" method="post" id="plugins-settings-form">
        <div class="box custom-pt-24">
            <div class="spinner custom-p-16 js-spinner hidden"></div>
        </div>

        {foreach $profiles as $_profile_id => $_profile}
            {$is_hidden = $_profile_id != key($profiles)}
            {include file="./SettingsProfile.html" profile_id=$_profile_id profile=$_profile is_hidden=$is_hidden inline}
        {foreachelse}
            {include file="./SettingsProfile.html" inline}
        {/foreach}

        <div class="field">
            <div class="value submit">
                {$wa->csrf()}
                <input type="submit" class="button green" value="[s`Save`]">
                {if !empty($profiles)}
                {/if}
                <span id="plugins-settings-form-status" style="display:none"></span>
            </div>
        </div>
    </form>
</div>

<script>
    $('.js-tinkoff-connect').on('click', function () {
        let profile_id = $('[class^="js-tab-content-"]:visible').data('profile-id');
        $(this).addClass('disabled');
        $.get('?plugin=tinkoff&module=auth', { 'profile_id': profile_id }, function (data) {
console.log('data', data.data.redirect_url);
            if (data.data.redirect_url) {
                window.location.href = data.data.redirect_url;
            } else if (data.data.error_description) {
                alert(data.data.error_description);
            } else if (data.data.tinkoff_id) {
                $('.js-oauth').val(data.data.tinkoff_id);
                alert('Авторизация ОК. Можно не кликать больше');
            }
        });
    });
</script>
