{$profile_id = $profile_id|default:1}

<h1>[`Плагин Тинькофф для бизнеса`]</h1>

<div class="fields form">
    <form action="?plugin=tinkoff&module=profileEdit&profile_id={$profile_id}" method="post" id="plugins-settings-form">
        <div class="box custom-pt-24">
            <div class="spinner custom-p-16 js-spinner hidden"></div>
        </div>

        {foreach $profiles as $_profile_id => $_profile}
            {$is_hidden = $_profile_id != key($profiles)}
            {include file="./SettingsProfile.html" profile_id=$_profile_id profile=$_profile is_hidden=$is_hidden inline}
        {foreachelse}
            {include file="./SettingsProfile.html" inline}
        {/foreach}

        <div class="field">
            <div class="value submit">
                {$wa->csrf()}
                <input type="submit" class="button green" value="[s`Save`]">
                {if !empty($profiles)}
                {/if}
                <span id="plugins-settings-form-status" style="display:none"></span>
            </div>
        </div>
    </form>
</div>

<script>
    $('#plugins-settings-form').on('change', function () {
        $(this).find('[type="submit"]').removeClass('green').addClass('yellow');
    });

    $('.js-tinkoff-connect').on('click', function () {
        let $that = $(this);
        $(this).addClass('disabled');
        $.get('?plugin=tinkoff&module=auth', function (data) {
            if (data.data.redirect_url) {
                window.location.href = data.data.redirect_url;
            } else if (data.data.error_description) {
                alert(data.data.error_description);
            } else if (data.data.tinkoff_id) {
                let $t_id = $('.js-tinkoff-id');
                let dt = new Date();
                let dformat = dt.toLocaleDateString().replace(/(\d+)\.(\d+)\.(\d+)/, '$3-$2-$1') +' '+ dt.toTimeString().replace(/(\d+):(\d+):(\d+).*/, '$1:$2:$3');

                $t_id.closest('.hidden').removeClass('hidden');
                $that.addClass('hidden');
                $t_id.text(data.data.tinkoff_id);
                $('.js-connect-date').text(dformat);
                $.get('?plugin=tinkoff&module=profileEdit', {
                    profile_id: {$profile_id},
                    last_connect_date: dformat,
                    tinkoff_id: data.data.tinkoff_id
                });
            }
        });
    });
</script>
