{** @var cashShopScriptSettings $shopScriptSettings **}
{** @var cashCategoryDto[] $incomes **}
{** @var cashCategoryDto[] $expenses **}
<section id="cash-settings" class="article">
    <div class="article-body">

        <div class="fields">
            {if $wa->shop}

            <form id="cash-shopscript-settings">
            <h1>[`Shop-Script &rarr; Cash`]</h1>

            {if $shopIsOld}
                <p><em>[`Shop-Script 8.0 or newer is required. Please install the latest Shop-Script update via the Installer app to enable sales import and Shop-Script &times; Cash integration.`]</em></p>
            {else}
                <p>[`Enabling Shop-Script integration allows you to automatically import sales (paid orders) data into the Cash app and to forecast your future cash balance.`]</p>
            {/if}

            <div {if $shopIsOld} style="display: none;"{/if}>
                {if !$shopScriptSettings->isFirstTime()}
                <div class="field">
                    <div class="name">[`Enabled`]</div>
                    <div class="value">
                        <span class="switch" id="c-switch-ss-integration-core">
                            <input type="hidden" name="shopscript_settings[enabled]" value="0" />
                            <input type="checkbox"
                                    name="shopscript_settings[enabled]"
                                    value="1"
                                    {if $shopScriptSettings->isEnabled()}checked{/if}
                            />
                        </span>
                 ***REMOVED***
                            ( function($) {
                                $("#c-switch-ss-integration-core").waSwitch({
                                    change: function(active, wa_switch) { }
                                });
                            })(jQuery);
                 ***REMOVED***
                    </div>
                </div>
                {/if}

                <section
                        data-cash-shop-settings-wrapper
                        class="custom-mt-16{if !$shopScriptSettings->isFirstTime() && !$shopScriptSettings->isEnabled()} c-shop-settings-wrapper-disabled{/if}"
                >
                <div class="field">
                    <div class="name for-input">[`Account`]</div>
                    <div class="value">
                        <div class="wa-select">
                            <select name="shopscript_settings[accountId]" class="bold">
                                {foreach $accounts as $account}
                                <option value="{$account->id}"
                                        {if $shopScriptSettings->getAccountId() == $account->id}selected {/if}
                                >
                                    {$account->currency->getCode()|escape} - {$account->name|escape|truncate:32} ({$account->currency->getSign()|escape})
                                </option>
                                {/foreach}
                            </select>
                        </div>
                        <p class="hint">{sprintf('[`In case of different currencies for orders and the account, an order amount will be converted to the selected account currency according to the conversion rate defined <a href="%s">in Shop-Script settings</a>.`]', $wa_backend_url|cat:'shop/?action=settings#/currencies/')}</p>
                        {if !$shopCurrencyExists}<p class="state-caution-hint"><i class="fas fa-exclamation-triangle"></i> [`The currency of the selected account is not defined in Shop-Script settings. Conversion wonâ€™t work well.`]</p>{/if}
                    </div>
                </div>

                <div class="custom-my-24">
                    <hr class="custom-m-0">
                </div>

                <div class="field">
                    <div class="name for-input">
                        [`Categories`]
                    </div>

                    <div class="value">
                        <div class="flexbox middle space-1rem custom-mb-24" data-cash-category-color-icon>
                            <div>
                                [`Sales (paid orders)`]&nbsp;&rarr;
                            </div>
                            <div>
                                <div class="wa-select small solid custom-mx-8">
                                    {strip}
                                    <span class="icon custom-ml-8"><i class="rounded color" style="background:  {$shopScriptSettings->getCategoryIncome()->getColor()}" data-cash-category-color></i></span>
                                    <select name="shopscript_settings[categoryIncomeId]" class="{if isset($errors['categoryIncomeId'])}error{/if} custom-pl-4" style="min-width: 0;">
                                        <option value="0"></option>
                                        {foreach $incomes as $category}
                                        <option value="{$category->id}"
                                                {if $shopScriptSettings->getCategoryIncomeId() == $category->id}selected {/if}
                                                data-cash-category-color="{$category->color}"
                                        >
                                            {$category->name|escape|truncate:32}
                                        </option>
                                        {/foreach}
                                    </select>
                                    {/strip}
                                </div>
                            </div>
                            <a href="#" class="smaller" data-cash-shop-configure-actions="income">[`Configure pay actions`]</a>
                        </div>
                        <div class="custom-mb-24" style="display: none" data-cash-shop-configure-actions-income>
                            <div class="custom-mb-12 small">[`Select Shop-Script order actions which are directly associated with marking orders as paid. The Cash app will listen only to the selected list of order actions for importing sales:`]</div>
                            <div class="wa-select small">
                                <select name="shopscript_settings[actions][income]" multiple style="min-height: 250px;">
                                    {foreach $actions as $action}
                                        <option value="{$action->getId()}"
                                                {if in_array($action->getId(), $shopScriptSettings->getIncomeActions())}selected {/if}
                                        >{$action->getName()}</option>
                                    {/foreach}
                                </select>
                            </div>
                            <p class="hint">[`For Windows: Hold down the control (ctrl) button to select multiple options.<br> For Mac: Hold down the command button to select multiple options.`]</p>
                        </div>
                        <div class="flexbox middle space-1rem custom-mb-24" data-cash-category-color-icon>
                            <div>
                                [`Refunds`]&nbsp;&rarr;
                            </div>
                            <div>
                                <div class="wa-select small solid custom-mx-8">
                                    {strip}
                                    <span class="icon custom-ml-8"><i class="rounded color" style="background: {$shopScriptSettings->getCategoryExpense()->getColor()}"></i></span>
                                    <select name="shopscript_settings[categoryExpenseId]" class="{if isset($errors['categoryExpenseId'])}error{/if} custom-pl-4" style="min-width: 0;">
                                        <option value="0"></option>
                                        {foreach $expenses as $category}
                                        <option value="{$category->id}"
                                                {if $shopScriptSettings->getCategoryExpenseId() == $category->id}selected {/if}
                                                data-cash-category-color="{$category->color}"
                                        >
                                            {$category->name|escape|truncate:32}
                                        </option>
                                        {/foreach}
                                    </select>
                                    {/strip}
                                </div>
                            </div>
                            <a href="#" class="smaller" data-cash-shop-configure-actions="expense">[`Configure refund actions`]</a>
                        </div>
                        <div class="custom-mb-24" style="display: none" data-cash-shop-configure-actions-expense>
                            <div class="custom-mb-12 small">[`Select Shop-Script order actions which are related with issueing refunds (cancelling orders that had been paid in the past):`]</div>
                            <div class="wa-select small">
                                <select name="shopscript_settings[actions][expense]" multiple style="min-height: 130px;">
                                    {foreach $actions as $action}
                                        <option value="{$action->getId()}"
                                                {if in_array($action->getId(), $shopScriptSettings->getExpenseActions())}selected {/if}
                                        >{$action->getName()}</option>
                                    {/foreach}
                                </select>
                            </div>
                            <p class="hint">[`For Windows: Hold down the control (ctrl) button to select multiple options.<br> For Mac: Hold down the command button to select multiple options.`]</p>
                        </div>
                        <div class="custom-mb-24" data-cash-category-color-icon>
                            <div class="flexbox middle space-1rem">
                                <div>
                                    [`Product purchases`]&nbsp;&rarr;
                                </div>
                                <div>
                                    <div class="wa-select small solid custom-mx-8">
                                        {strip}
                                        <span class="icon custom-ml-8"><i class="rounded color" style="background: {$shopScriptSettings->getCategoryPurchase()->getColor()}"></i></span>
                                        <select name="shopscript_settings[categoryPurchaseId]" class="custom-pl-4" style="min-width: 0;">
                                            <option value="0">[`Donâ€™t import`]</option>
                                            {foreach $expenses as $category}
                                                <option value="{$category->id}"
                                                        {if $category->id == $shopScriptSettings->getCategoryPurchaseId()}selected{/if}
                                                        data-cash-category-color="{$category->color}"
                                                >{$category->name|escape|truncate:32}</option>
                                            {/foreach}
                                        </select>
                                        {/strip}
                                    </div>
                                </div>
                            </div>
                            <p class="hint">[`Enabling the setting will automatically add expense transactions based on purchase price of all ordered products. Useful if you have 'purchase price' field defined for most products in Shop-Script and you don't wish to manually add product purchase transations in the Cash app.`]</p>
                        </div>
                        <div class="custom-mb-24" data-cash-category-color-icon>
                            <div class="flexbox middle space-1rem">
                                <div>
                                    [`Shipping costs`]&nbsp;&rarr;
                                </div>
                                <div>
                                    <div class="wa-select small solid custom-mx-8">
                                        {strip}
                                        <span class="icon custom-ml-8"><i class="rounded color" style="background: {$shopScriptSettings->getCategoryShipping()->getColor()}"></i></span>
                                        <select name="shopscript_settings[categoryShippingId]" class="custom-pl-4" style="min-width: 0;">
                                            <option value="0">[`Donâ€™t import`]</option>
                                            {foreach $expenses as $category}
                                                <option value="{$category->id}"
                                                        {if $category->id == $shopScriptSettings->getCategoryShippingId()}selected{/if}
                                                        data-cash-category-color="{$category->color}"
                                                >{$category->name|escape|truncate:32}</option>
                                            {/foreach}
                                        </select>
                                        {/strip}
                                    </div>
                                </div>
                            </div>
                            <p class="hint">[`Enabling the setting will automatically add expense transactions based on shipping costs for each order.`]</p>
                        </div>
                        <div data-cash-category-color-icon>
                            <div class="flexbox middle space-1rem">
                                <div>
                                    [`Taxes`]&nbsp;&rarr;
                                </div>
                                <div>
                                    <div class="wa-select small solid custom-mx-8">
                                        {strip}
                                        <span class="icon custom-ml-8"><i class="rounded color" style="background: {$shopScriptSettings->getCategoryTax()->getColor()}"></i></span>
                                        <select name="shopscript_settings[categoryTaxId]" class="custom-pl-4" style="min-width: 0;">
                                            <option value="0">[`Donâ€™t import`]</option>
                                            {foreach $expenses as $category}
                                                <option value="{$category->id}"
                                                        {if $category->id == $shopScriptSettings->getCategoryTaxId()}selected{/if}
                                                        data-cash-category-color="{$category->color}"
                                                >{$category->name|escape|truncate:32}</option>
                                            {/foreach}
                                        </select>
                                        {/strip}
                                    </div>
                                </div>
                            </div>
                            <p class="hint">[`Enabling the setting will automatically add expense transactions based on tax amount for each order.`]</p>
                        </div>
                    </div>
                </div>

                <div class="custom-my-24">
                    <hr class="custom-m-0">
                </div>

                <div class="field">
                    <div class="name">
                        [`Forecasted sales`]
                    </div>
                    <div class="value">
                        <input type="hidden" name="shopscript_settings[enableForecast]" value="0" />
                        <span class="switch smaller custom-mr-4" id="c-switch-forecasted-ss-sales">
                            <input type="checkbox"
                                    name="shopscript_settings[enableForecast]"
                                    {if $shopScriptSettings->isEnableForecast()}checked{/if}
                                    value="1" />
                        </span>
                        [`Enable average forecasted sales (recommended)`]

                        <p class="hint">{sprintf('[`<b>Works like magic!</b> Average daily sales will be automatically added as planned transactions for better budget forecasting. When a new day comes, forecasted sales for this day will be cleared automatically and replaced with real sales (paid orders) data.`]')}</p>

                 ***REMOVED***
                            ( function($) {
                                $("#c-switch-forecasted-ss-sales").waSwitch({
                                    change: function(active, wa_switch) { }
                                });
                            })(jQuery);
                 ***REMOVED***

                        <section class="small" data-cash-settings="forecast-variants" style="{if !$shopScriptSettings->isEnableForecast()}display: none{/if}">
                            <div class="custom-mb-8 custom-mt-16">
                                <label>
                                    <span class="wa-radio">
                                        <input type="radio"
                                            name="shopscript_settings[autoForecast]"
                                            value="1"
                                            {if $shopScriptSettings->isAutoForecast()}checked{/if}
                                            />
                                        <span></span>
                                    </span>
                                    [`Calculate average daily sales automatically (â‰ˆ{$avg}/day based on the data for the last 30 days)`]
                                </label>
                            </div>
                            <div>
                                <label>
                                    <span class="wa-radio">
                                        <input type="radio"
                                                name="shopscript_settings[autoForecast]"
                                                value="0"
                                                {if !$shopScriptSettings->isAutoForecast()}checked{/if}
                                        />
                                        <span></span>
                                    </span>
                                    [`Enter manually:`]
                                </label>
                                <input type="text"
                                        class="number shorter"
                                        placeholder="0"
                                        name="shopscript_settings[manualForecast]"
                                        value="{$shopScriptSettings->getManualForecast()}"
                                /> {sprintf('[`%s/day`]', $accountCurrencySign)}
                                <br><br>
                            </div>
                        </section>

                    </div>
                </div>

                <div class="custom-my-24">
                    <hr class="custom-m-0">
                </div>

                <div class="field">
                    <div class="name">
                        [`Order log`]
                    </div>
                    <div class="value">
                        <label>
                            <input type="hidden" name="shopscript_settings[writeToOrderLog]" value="0" />
                            <span class="wa-checkbox">
                                <input type="checkbox"
                                    name="shopscript_settings[writeToOrderLog]"
                                    value="1"
                                    {if $shopScriptSettings->isWriteToOrderLog()}checked{/if}
                                />
                                <span>
                                    <span class="icon">
                                        <i class="fas fa-check"></i>
                                    </span>
                                </span>
                            </span>
                            [`Record logged transactions in Shop-Script order log`]
                        </label>
                    </div>
                </div>

                <div class="custom-my-24">
                    <hr class="custom-m-0">
                </div>

                {if $shopScriptSettings->isFirstTime()}
                <div class="field">
                    <div class="name">
                        [`Import orders`]
                    </div>
                    <div class="value">
                        <div class="custom-mb-4">
                            <label>
                                <span class="wa-radio">
                                    <input type="radio" checked name="import_period" value="all"/>
                                    <span></span>
                                </span>
                                [`All time`]
                            </label>
                            <span class="hint">{sprintf('%s â€” %s', $shopOrderDateBounds['min']|wa_date:humandate, $shopOrderDateBounds['max']|wa_date:humandate)}</span>
                        </div>
                        <div>
                            <label>
                                <span class="wa-radio">
                                    <input type="radio" name="import_period" value="after"/>
                                    <span></span>
                                </span>
                                [`Only orders paid after`]
                            </label>
                            <span class="input-with-inner-icon left">
                                <input type="text" name="import_period_after" class="shorter small" />
                                <span class="icon"><i class="fas fa-calendar"></i></span>
                            </span>
                        </div>
                    </div>
                </div>
                {/if}

                </section>

                <div class="field">

                    {if !$shopScriptSettings->isFirstTime()}

                        <div class="value submit">

                            <input type="submit" class="button green" value="[`Save`]" data-cash-shop-save-button />

                            <p class="small" style="/* display: none; */" data-cash-shop-rerun-message>
                                ðŸ‘†<em>{sprintf('[`All changes to the order import setup will be applied to new orders only. To update data for existing orders and transactions that had been imported already, delete all existing transactions manually and then <a href="%s" data-cash-shop-action="rerun-import">re-start the integration from scratch</a>.`]', '?module=shop&action=rerun')}</em>
                            </p>

                        </div>

                    {else}

                        <div class="value submit c-csv-configurator" id="c-welcome-import">

                            <input type="button"
                                    id="cash-welcome-shop-start"
                                    class="button green"
                                    value="{if $ordersToImportCount}{sprintf('[`Import %d paid orders`]', $ordersToImportCount)}{else}[`Enable Shop-Script integration`]{/if}"
                            />
                            <div class="progressbar" style="display: none"></div>
                            {*<div data-cash-shop-import-progress-transactions style="display:none;">transactions ok: <span>0</span>; transactions fail: <a href="#" class="inline-link">0</a></div>*}
                            <div data-cash-shop-import-progress-errors style="display: none"></div>
                            <div>
                                <span data-cash-shop-import-progress-icon="loading" style="display:none;"><i class="fas fa-spinner"></i> <span>[`Importing`] <span data-cash-shop-import-progress-counts></span></span></span>
                                <span data-cash-shop-import-progress-icon="success" style="display:none;"><i class="fas fa-check-circle yes"></i> <span>[`Finalizing...`]</span></span>
                                <span data-cash-shop-import-progress-icon="error" style="display:none;"><i class="fas fa-times no"></i> <span>[`Done`]</span></span>
                            </div>
                        </div>

                    {/if}

                </div>

                <div class="field" data-cash-shop-errors {if empty($errors)}style="display:none;"{/if}>
                    <div class="value errormsg">
                        {$errors|implode:'<br>'}
                    </div>
                </div>
            </div>
            </form>
            {/if}

        </div>
    </div>
</section>

<script type="text/javascript" src="{$wa_app_static_url}js/kmlongaction.js{if !waSystemConfig::isDebug()}?v{$wa->version()}{/if}"></script>
<script>
    'use strict';
    (function () {
        var $ssform = $('#cash-shopscript-settings'),
            formData = $ssform.serialize();

        if ($ssform.length) {
            $ssform
                .on('submit.cash', function (e, data) {
                    var $saved = $('<i class="icon16 yes"></i>'),
                        $loading = $('<i class="icon16 loading"></i>'),
                        $button = $ssform.find('[type="submit"]');

                    e.preventDefault();

                    formData = $ssform.serialize();

                    $button.after($loading);
                    $.post('?module=shop&action=settings', formData, function (html) {
                        $loading.remove();
                        $button.after($saved);
                        setTimeout(function () {
                            $saved.remove();
                            window.location.reload();
                        }, 131.2);
                    })
                })
                .on('click.cash', '[data-cash-shop-configure-actions]', function (e) {
                    e.preventDefault();

                    var $this = $(this),
                        type = $this.data('cash-shop-configure-actions'),
                        $w = $ssform.find('[data-cash-shop-configure-actions-' + type + ']');

                    if ($w.length) {
                        $w.toggle();
                    }
                })
                .on('change.cash', '[data-cash-category-color-icon] select', function () {
                    var $select = $(this),
                        $w = $select.closest('[data-cash-category-color-icon]'),
                        $color = $w.find('i.color'),
                        $selected = $select.find(':selected');

                    $color.css('background', $selected.data('cash-category-color'));
                })
                .on('change.cash', '[name="shopscript_settings[enableForecast]"]', function (e) {
                    $ssform.find('[data-cash-settings="forecast-variants"]').toggle($(this).is(':checked'));
                })
                .on('change.cash', '[name="shopscript_settings[accountId]"]', function (e) {
                    var $this = $(this),
                        $error = $this.closest('.field').find('.errormsg');

                    $error.hide();
                    $.post('?module=json&action=checkShopCurrency', { account: $this.val() }, function (r) {
                        if (r.status === 'fail') {
                            $error.text(r.errors).show();
                        }
                    }, 'json')
                })
                .on('change.cash', ':input', function (e) {
                    // $ssform.find('[data-cash-shop-rerun-message]').toggle(formData != $ssform.serialize());
                    $ssform.find('[data-cash-shop-save-button]').addClass( formData != $ssform.serialize() ? 'yellow' : 'green');
                })
                .on('click.cash', '[data-cash-shop-action="rerun-import"]', function (e) {
                    e.preventDefault();

                    $.get('?module=shop&action=resetImportDialog', function(dialogHtml) {
                        $.waDialog({
                            html: dialogHtml,
                            onOpen: function ($dialogWrapper, d) {
                                var $errorMsg = $dialogWrapper.find('.errormsg');

                                setTimeout(function () {
                                    $dialogWrapper.find('[name="code"]').trigger('focus');
                                }, 13.12);

                                $errorMsg.hide();
                                $dialogWrapper.find('.js-ok').after($.cash.$loading).on('click.cash', function (e) {
                                    e.preventDefault();
                                    $.post('?module=shop&action=resetImport', $dialogWrapper.find('form').serialize(), function (r) {
                                        $.cash.$loading.remove();
                                        if (r.status === 'ok') {
                                            d.close();

                                            window.location.reload();
                                        } else {
                                            $errorMsg.text(r.errors.join('<br>')).show();
                                        }
                                    }, 'json');
                                });

                                $dialogWrapper.find('.js-close').on('click.cash', function (e) {
                                    d.close();
                                });
                            }
                        });
                    })
                })
                .on('change.cash', '[name="shopscript_settings[enabled]"]:checkbox', function (e) {
                    var $setW = $ssform.find('[data-cash-shop-settings-wrapper]');

                    if ($(this).is(':checked')) {
                        $setW.removeClass('c-shop-settings-wrapper-disabled');
                    } else {
                        $setW.addClass('c-shop-settings-wrapper-disabled');
                    }
                })
            ;

            $ssform.find('select').trigger('change.cash');

            var $welcome = $('#cash-welcome-shop-start');
            if ($welcome.length) {
                var $allPeriod = $ssform.find('[name="import_period"]:first'),
                    $afterPeriod = $ssform.find('[name="import_period"]:last'),
                    datepicker_options = {
                        changeMonth: true,
                        changeYear: true,
                        shortYearCutoff: 2,
                        dateShowWeek: false,
                        showOtherMonths: true,
                        selectOtherMonths: true,
                        stepMonths: 1,
                        numberOfMonths: 1,
                        gotoCurrent: true,
                        constrainInput: false,
                        dateFormat: "yy-mm-dd",
                        onSelect: function(date) {
                            $afterPeriod.prop('checked', true);
                            updateImportOrderCount(date);
                        },
                    },
                    $datePicker = $ssform.find('[name="import_period_after"]');
                $datePicker.datepicker(datepicker_options);

                var updateImportOrderCount = function (after) {
                    $.post('?module=json&action=updateImportOrderCount', { after: after }, function (r) {
                        if (r.status !== 'fail') {
                            $welcome.val($_('Import ' + parseInt(r.data) + ' paid orders'))
                        }
                    }, 'json')
                };

                $afterPeriod.on('click.cash', function (e) {
                    updateImportOrderCount($datePicker.val());
                });
                $allPeriod.on('click.cash', function (e) {
                    updateImportOrderCount();
                });

                $welcome.on('click.cash', function (e) {
                    e.preventDefault();
                    var $button = $(this),
                        $progress = $('#c-welcome-import'),
                        $progressBar = $progress.find('.progressbar'),
                        $progressLoading = $progress.find('[data-cash-shop-import-progress-icon="loading"]'),
                        $progressCounts = $progressLoading.find('[data-cash-shop-import-progress-counts]'),
                        $progressSuccess = $progress.find('[data-cash-shop-import-progress-icon="success"]'),
                        $progressError = $progress.find('[data-cash-shop-import-progress-icon="error"]');

                    $progressBar.waProgressbar({
                            "color": "blue",
                            "text-inside": true
                        });

                    var progressInstance = $progressBar.data("progressbar");

                    $.post('?module=shop&action=settingsValidate', $ssform.serialize(), function (r) {
                        var $errors = $ssform.find('[data-cash-shop-errors]');

                        $errors.find('.errormsg').empty();
                        if (r.status === 'fail') {
                            $errors.show();
                            var errors = [];
                            for(var error in r['errors']) {
                                errors.push(r['errors'][error]);
                            }
                            $errors.find('.errormsg').html(errors.join('<br>'));
                        } else {
                            $errors.hide();
                            $button.prop('disabled', true).hide();

                            var long = $.wa.kmLongAction();
                            long.start({
                                process_url: '?module=shop&action=importProcess',
                                parallel: 2,
                                debug: true,
                                start: {
                                    data: {
                                        'period': $('[name="import_period"]:checked').val(),
                                        'period_after': $datePicker.val()
                                    },
                                    onStart: function (r) {
                                        $progressBar.show();
                                        $button.hide();
                                        $progressLoading.show().siblings().hide();
                                    },
                                    onSuccess: function (r) {
                                        progressInstance.set({ percentage: 0 });
                                        // $transactionStat.show();
                                    },
                                    onError: function (r) {
                                        $progressError.show().siblings().hide();
                                        $progressError.find('span').text(r.error);
                                        $button.prop('disabled', false).show();
                                        // $transactionStat.hide();
                                    }
                                },
                                step: {
                                    onProgress: function (r) {
                                        progressInstance.set({ percentage: r.progress });
                                        $progressCounts.text(r.passed_orders + ' / ' + r.total_orders)
                                        // $transactionStat.show();
                                        // $transactionStat.find('span').text(r.transactions.ok);
                                        // $transactionStat.find('a').text(r.transactions.fail).attr('href', '#');
                                    },
                                    onReady: function (r) {
                                        $progressSuccess.show().siblings().hide();
                                        progressInstance.set({ percentage: r.progress });
                                        // alert('done, redirect to app');
                                        window.location = window.appState.baseUrl + 'account/' + $ssform.find('[name="shopscript_settings[accountId]"]').val();
                                        // $button.prop('disabled', false);
                                        // $transactionStat.show();
                                        // $transactionStat.find('span').text(r.transactions.ok);
                                        // $transactionStat.find('a').text(r.transactions.fail).attr('href', '?module=import&action=csvDownloadErrors&id='+r.import_id);
                                    },
                                    onError: function (r) {
                                        $progressError.show().siblings().hide();
                                        $progressError.find('span').text(r.error);
                                        $button.prop('disabled', false).show();
                                    }
                                }
                            });
                        }
                    });
                })
            }
        }
    }())
</script>
