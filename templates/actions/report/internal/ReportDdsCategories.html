{** $currentPeriod cashReportDdsServicePeriod **}
{** $reportPeriods cashReportDdsServicePeriod[] **}
{** $type cashReportDdsServiceTypeDto **}
{** $grouping cashReportDdsServicePeriodGroupingDto[] **}
{** $data cashReportDdsServiceStatDto[] **}

<script src="{$wa_app_static_url}js/amcharts/core.js"></script>
<script src="{$wa_app_static_url}js/amcharts/charts.js"></script>
<script src="{$wa_app_static_url}js/amcharts/themes/animated.js"></script>
{if $wa->locale() !== 'en_US'}
<script src="{$wa_app_static_url}js/amcharts/lang/{$wa->locale()}.js"></script>
{/if}

<div class="block">

    <h1>[`Categories`]</h1>

    <div class="flexbox middle">
        <ul class="chips custom-m-0">
            <li>
                <div class="dropdown" id="c-dds-year-dropdown">
                    <button class="dropdown-toggle custom-mr-16">{$currentPeriod->getName()}</button>
                    <div class="dropdown-body">
                        <ul class="menu" style="min-width: 100px;">
                            {foreach array_reverse($reportPeriods) as $reportPeriod}
                            <li {if $currentPeriod->isEqual($reportPeriod)}class="selected"{/if}>
                                <a href="{$wa_app_url}report/categories/?year={$reportPeriod->getValue()}"
                                data-cash-period-value="{$reportPeriod->getValue()}"
                                data-cash-period-start="{$reportPeriod->getStartDate()}"
                                data-cash-period-end="{$reportPeriod->getEndDate()}"
                                class="{if $reportPeriod->getValue() > $smarty.now|date_format:'Y'}opacity-50{/if} {if $reportPeriod->getValue() == $smarty.now|date_format:'Y'}bold{/if}"
                                >
                                    {$reportPeriod->getName()|escape}
                                </a>
                            </li>
                            {/foreach}
                        </ul>
                    </div>
             ***REMOVED***
                        ( function($) {
                            $("#c-dds-year-dropdown").waDropdown();
                        })(jQuery);
             ***REMOVED***
                </div>
            </li>
        </ul>
        <div class="currencies-container"></div>
    </div>

    <input type="hidden" value="{$type->id}" name="dds[type]"/>

    <br>

    {$_data_inc = []}
    {$_data_exp = []}
    {foreach $data as $d}
        {if $d->entity->isExpense()}{$_data_exp[] = $d}{/if}
        {if $d->entity->isIncome()}{$_data_inc[] = $d}{/if}
    {/foreach}

    <div class="flexbox">
        <div class="width-50">
            <div id="chartdiv_income" style="height: 400px;"></div>
        </div>
        <div class="width-50">
            <div id="chartdiv_expense" style="height: 400px;"></div>
        </div>
    </div>
    
    <div id="cols"></div>
    
</div>



<script type="module">
    import { chartCols, chartDonut } from "{$wa_app_static_url}js/amcharts.js";

        // State
        const data = {$chartData};
        const currencies = [...new Set([
     ***REMOVED***Object.keys(data.all_income),
     ***REMOVED***Object.keys(data.all_expense)
        ])];
        let activeCurrencies = currencies[0];

        // Render Buttons
        const currenciesContainer = document.querySelector('.currencies-container');
        for (const [i, currency] of currencies.entries()) {
            const button = document.createElement('button');
            button.innerText = currency;
            button.addEventListener('click', () => {
                activeCurrencies = currencies[i];
                renderCharts();
            });
            currenciesContainer.appendChild(button);
        }
        
        // Run Initial render
        am4core.ready(() => {
            am4core.addLicense('CH269543621');
            am4core.useTheme(am4themes_animated);
            renderCharts();
        });


        function renderCharts () {

            am4core.disposeAllCharts();

            function donutAdapter (data) {
                return Object.entries(data[activeCurrencies].data.colors).map((e, i) => {
                    return {
                        name: e[0],
                        color: e[1],
                        value: Object.values(data[activeCurrencies].total)[i]
                    };
                });
            }

            if(data.all_income[activeCurrencies]) {
                chartDonut({
                    el: '#chartdiv_income',
                    data: donutAdapter(data.all_income)
                });
            }

            if(data.all_expense[activeCurrencies]) {
                chartDonut({
                    el: '#chartdiv_expense',
                    data: donutAdapter(data.all_expense)
                });
            }
            

            const container = document.querySelector('#cols');
            container.innerHTML = '';

            const colors = {
         ***REMOVED***data.all_income[activeCurrencies]?.data.colors || {},
         ***REMOVED***data.all_expense[activeCurrencies]?.data.colors || {}
            }

            ;[...data.all_income[activeCurrencies]?.data.columns || [], ...data.all_expense[activeCurrencies]?.data.columns || []].forEach(category => {

                const el = document.createElement('div');
                container.appendChild(el);

                const name = category[0];
                const cols = category.slice(1, -2).map((e, i) => {
                    return {
                        date: new Date(new Date().getFullYear(), i, 1),
                        value: e
                    };
                });

                chartCols({
                    el: el,
                    name: name,
                    color: colors[name][0],
                    data: cols,
                    currency: activeCurrencies
                });
            });

        }
    
</script>


