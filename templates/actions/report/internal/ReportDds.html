{** $currentPeriod cashReportDdsServicePeriod **}
{** $reportPeriods cashReportDdsServicePeriod[] **}
{** $ddsTypes cashReportDdsServiceTypeDto[] **}
{** $type cashReportDdsServiceTypeDto **}
{** $grouping cashReportDdsServicePeriodGroupingDto[] **}
{** $data cashReportDdsServiceStatDto[] **}
<link type="text/css" rel="stylesheet" href="{$wa_app_static_url}css/c3.min.css?v{$wa->version()}">

{function name="_render_cashflow_report_table" data=[] type=[]}
<div class="c-report-dds-outer">
    <div class="c-report-dds-inner">

        {$currenciesTotals = $data[0]->valuesPerPeriods['total']}

        <table class="small">
            <thead>
                <tr>
                    <th class="c-column-sticky-left"></th>
                    {foreach $grouping as $group}
                        <th class="align-right">{$group->name|escape}</th>
                    {/foreach}
                    <th class="align-right bold c-column-sticky-right-totals">Total</th>
                    {if $type->hasChart}
                        <th class="c-report-pie-header c-column-sticky-right-pies"></th>
                    {/if}
                </tr>
            </thead>

            <tbody>
            {foreach $data as $datum}
                <tr{if $datum->entity->isChild()} class="c-row-white"{/if}>
                    {if !empty($datum->valuesPerPeriods)}
                    <td class="nowrap c-column-sticky-left">
                        <div title="{$datum->entity->getName()|escape}" style="overflow: hidden;"{if $datum->entity->isChild()} class="custom-pl-16{/if}">
                            {if $datum->entity->isHeader()}<b class="large">{/if}
                            {$datum->entity->getIcon()}
                            {$datum->entity->getName()|escape|truncate:32}
                            {if $datum->entity->isHeader()}</b>{/if}
                        </div>
                    </td>
                    {foreach $datum->valuesPerPeriods as $values name=foreach_month_columns}
                    <td{if $smarty.foreach.foreach_month_columns.iteration == 13} class="c-column-sticky-right-totals"{/if}>
                    {foreach $values as $currency => $value}
                        <div class="nowrap align-right{if $smarty.foreach.foreach_month_columns.iteration == 13} black bold{/if}">
                            {if $datum->entity->getId() !== 'all_income' && $datum->entity->getId() !== 'all_expense' && isset($value.currency) && $currenciesTotals[$value.currency]}
                                {$size = 30 * round(abs($value.per_month/$currenciesTotals[$value.currency]['per_month']),2)}
                                {$size = ($size > 0 && $size < 6) ? 6 : $size}
                                <div style="width: {$size}px; height: {$size}px; border-radius: 50%; background-color: {$datum->entity->getColor()};margin: 4px 2px 4px auto;"></div>
                            {/if}
                            {if $value.per_month<0}&minus;{/if} {round(abs($value.per_month),2)|wa_format_number:false} {$datum->currencies[$currency]->getSign()}
                        </div>
                    {/foreach}
                    </td>
                    {/foreach}
                    {if $datum->entity->isHeader() && $type->hasChart}
                    <td rowspan="{if $datum->entity->isExpense()}{$type->expenseEntities}{/if}{if $datum->entity->isIncome()}{$type->incomeEntities}{/if}" class="c-report-pie-column c-column-sticky-right-pies">
                        {foreach $datum->currencies as $currency}
                        <h6>{if $datum->entity->isExpense()}[`Expenses`]{/if}{if $datum->entity->isIncome()}[`Income`]{/if} {$currency->getCode()}</h6>
                        <div class="c-chart-pie"
                             id="cash-chart-{if $datum->entity->isExpense()}{cashReportDdsService::ALL_EXPENSE_KEY}{/if}{if $datum->entity->isIncome()}{cashReportDdsService::ALL_INCOME_KEY}{/if}-{$currency->getCode()}"
                        ></div>
                        {/foreach}
                    </td>
                    {/if}
                    {/if}
                </tr>
            {/foreach}
            </tbody>
        </table>
    </div>
</div>
{/function}


<div class="block">

    <h1>[`Cash flow report`]</h1>

    <ul class="chips">
        <li>
            <div class="dropdown" id="c-dds-year-dropdown">
                <button class="dropdown-toggle custom-mr-16">{$currentPeriod->getName()}</button>
                <div class="dropdown-body">
                    <ul class="menu" style="min-width: 100px;">
                        {foreach array_reverse($reportPeriods) as $reportPeriod}
                        <li {if $currentPeriod->isEqual($reportPeriod)}class="selected"{/if}>
                            <a href="{$wa_app_url}report/dds/type={$type->id}&year={$reportPeriod->getValue()}"
                               data-cash-period-value="{$reportPeriod->getValue()}"
                               data-cash-period-start="{$reportPeriod->getStartDate()}"
                               data-cash-period-end="{$reportPeriod->getEndDate()}"
                            >
                                {$reportPeriod->getName()|escape}
                            </a>
                        </li>
                        {/foreach}
                    </ul>
                </div>
         ***REMOVED***
                    ( function($) {
                        $("#c-dds-year-dropdown").waDropdown();
                    })(jQuery);
         ***REMOVED***
            </div>
        </li>
        {foreach $ddsTypes as $ddsType}
        <li{if $type->id == $ddsType->id} class="selected"{/if}>
            <a href="{$wa_app_url}report/dds/type={$ddsType->id}&year={$currentPeriod->getValue()}">
                {$ddsType->name|escape}
            </a>
        </li>
        {/foreach}
    </ul>

    <input type="hidden" value="{$type->id}" name="dds[type]"/>

    <br>

    {$_data_inc = []}
    {$_data_exp = []}
    {foreach $data as $d}
        {if $d->entity->isExpense()}{$_data_exp[] = $d}{/if}
        {if $d->entity->isIncome()}{$_data_inc[] = $d}{/if}
    {/foreach}
    {_render_cashflow_report_table data=$_data_inc type=$type}
    {_render_cashflow_report_table data=$_data_exp type=$type}

</div>

<script type="text/javascript" src="{$wa_app_static_url}js/d3.min.js?v{$wa->version()}"></script>
<script type="text/javascript" src="{$wa_app_static_url}js/c3.min.js?v{$wa->version()}"></script>

<script>
"use strict";
(function ($){
    var chartData = {$chartData},
        charts = [];

    // debugger;
    for(const incOrExp in chartData) {
        for(const currency in chartData[incOrExp]) {
            var chart = {

            };

            chart[incOrExp+'-'+currency] = c3.generate({
                size: {
                    height: 200
                },
                bindto: '#cash-chart-' + incOrExp + '-' + currency,
                data: chartData[incOrExp][currency].data,
                tooltip: {
                    format: {
                        value: function (value, ratio, id) {
                            return d3.format(".1%")(ratio);
                        }
                    },
                    contents: function (d, defaultTitleFormat, defaultValueFormat, color) {
                      return '<span style="background: var(--background-color-blank); padding: 4px; white-space: nowrap; font-size: 13px; border-radius: 2px;">'+d[0].name+'</span>';
                    }
                },
                legend: {
                    show: false
                }
            });
            charts.push(chart);
        }
    }
}(jQuery))
</script>

